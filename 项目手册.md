# 项目手册（Feishu Bitable Receiver）

## 1. 项目简介
Feishu Bitable Receiver 是一套部署在内网的飞书机器人服务，用于：
- 接收用户发送的多维表格（Bitable）链接
- 自动拉取表数据并保存为 Excel（xlsx）
- 基于预算表生成桑基图（HTML）
- 在飞书中仅回复一条消息：
  - 成功：`桑基图链接：<HTTP URL>`（可点击）
  - 失败：`桑基图生成失败，请联系服务管理员`
  - 非 Bitable 链接：`该内容不能进行桑基图生成`

## 2. 主要功能
- 多维表格拉取：支持 base+table[+view] 或仅 base（自动选首表首视图）
- Excel 仅导出：文件命名为 `多维表格名称-发送者ID-北京时间.xlsx`
- 桑基图生成：
  - 边表命名：`{预算文件名}_edges.xlsx`
  - HTML 命名：`{预算文件名}_桑基图.html`
- 链接返回：
  - 通过 `/sankey/<filename>` 提供只读访问（中文文件名已 URL 编码）
- 幂等：基于 `message_id` 确保同一事件只处理一次、只回复一次

## 3. 目录结构（关键）
- `app/main.py`：Flask 应用主入口与路由（/feishu/events、/sankey/...、/healthz）
- `app/sankey_service_with_polling.py`：桑基图服务（内置版本，单次生成）
- `pull_bitable.py`：拉取 Bitable 记录并导出 Excel
- `wsgi.py`：Gunicorn 的 WSGI 入口
- `requirements.txt`：依赖

## 4. 运行环境与依赖
- Linux 内网环境，Python ≥ 3.9（已在 3.13 验证）
- 依赖：
  ```
  flask==3.0.3
  python-dotenv==1.0.1
  gunicorn==21.2.0
  requests==2.32.3
  openpyxl==3.1.5
  pandas>=1.5.0
  pyecharts>=2.0.0
  ```
- 离线安装：在可联网机器 `pip download` → SFTP 上传 → `pip install --no-index --find-links=...`

## 5. 配置（.env）
```env
# ========= Feishu credentials =========
APP_ID=cli_xxx
APP_SECRET=xxxxxx
OPEN_BASE=https://open.w.cnooc.com.cn
VERIFICATION_TOKEN=
ENCRYPT_KEY=

# ========= Service =========
PORT=3000
HOST=0.0.0.0

# ========= 文件导出 =========
OUTPUT_DIR=/home/cnooc/file/excel
EXPORT_CSV=false
EXPORT_XLSX=true
BASE_AUTO_PICK=first
BASE_PREFERRED_TABLE=
BASE_PREFERRED_VIEW=

# ========= 日志 =========
MESSAGES_LOG_PATH=/home/cnooc/python_app/feishu-bitable-receiver/logs/messages.log

# ========= 桑基图 =========
SANKEY_SERVICE_PATH=
SANKEY_OUTPUT_DIR=/home/cnooc/file/sankey
SANKEY_WATCH_DIR=/home/cnooc/file/excel
SANKEY_LOG_FILE=/home/cnooc/python_app/feishu-bitable-receiver/logs/sankey_service.log
SANKEY_POLL_INTERVAL=2
# 可选：若用 Nginx 提供静态访问，设置为 http://IP:端口/sankey
SANKEY_HTML_BASE_URL=
```

### 5.1 生产示例配置（当前内网服务器）
```env
# ========= Feishu credentials =========
APP_ID=cli_a8733bb23078d3c7              # 飞书应用 App ID
APP_SECRET=ouoBZs21TFNBXp0V15P1IcdVk51gvZz0  # 飞书应用 App Secret
OPEN_BASE=https://open.w.cnooc.com.cn    # 私有化网关
VERIFICATION_TOKEN=                      # 事件订阅校验（如启用）
ENCRYPT_KEY=                             # 事件签名密钥（推荐）

# ========= Service =========
PORT=3000                                # 服务端口
HOST=0.0.0.0                             # 监听地址（0.0.0.0 表示所有网卡）

# ========= 文件导出配置 =========
OUTPUT_DIR=/home/cnooc/file/excel        # Excel 输出目录
EXPORT_CSV=false                         # 固定 false（只导出 Excel）
EXPORT_XLSX=true                         # 固定 true
BASE_AUTO_PICK=first                     # 仅 base 链接时自动选择首表首视图
BASE_PREFERRED_TABLE=                    # 若按名称优先可填表名（可留空）
BASE_PREFERRED_VIEW=                     # 若按名称优先可填视图名（可留空）

# ========= 日志 =========
MESSAGES_LOG_PATH=/home/cnooc/python_app/feishu-bitable-receiver/logs/messages.log

# ========= 桑基图 =========
SANKEY_SERVICE_PATH=                     # 已内置，可留空
SANKEY_OUTPUT_DIR=/home/cnooc/file/sankey # HTML 输出目录
SANKEY_WATCH_DIR=/home/cnooc/file/excel  # 工作目录（通常与 OUTPUT_DIR 一致）
SANKEY_LOG_FILE=/home/cnooc/python_app/feishu-bitable-receiver/logs/sankey_service.log
SANKEY_POLL_INTERVAL=2                   # 兼容初始化用，实际不启轮询
```

### 5.2 如何更新 .env
```bash
# 方式一：服务器上直接编辑
ssh cnooc@10.77.79.147
cd /home/cnooc/python_app/feishu-bitable-receiver
cp -n .env .env.bak.$(date +%Y%m%d%H%M)   # 可选备份
vim .env                                  # 或 nano .env

# 修改后重启（nohup）
source /home/cnooc/python_app/venv313/bin/activate
kill $(cat gunicorn.pid) 2>/dev/null || pkill -f "gunicorn .*wsgi:app" || true
nohup gunicorn -w 3 --threads 2 --timeout 120 -b 0.0.0.0:3000 \
  --access-logfile ./logs/access.log \
  --error-logfile  ./logs/error.log  \
  --log-level info --capture-output \
  wsgi:app >/dev/null 2>&1 &
echo $! > gunicorn.pid

# 方式二：本地修改后上传覆盖
scp .env cnooc@10.77.79.147:/home/cnooc/python_app/feishu-bitable-receiver/.env
# 然后按上面的重启命令重启
```

## 6. 飞书平台配置
- 事件订阅：
  - 回调 URL：`http://<内网IP>:3000/feishu/events`
  - 订阅事件：`im.message.receive_v1`
  - 安全校验：Verification Token（与 .env 一致，可选）、Encrypt Key（推荐）
- 权限（Scopes）：
  - `im:message:send_as_bot`（以应用身份发送/回复消息）
  - `bitable:app:readonly` 或等价只读权限（读取表/视图/字段/记录）
  - 若用于群聊，勾选相应群聊读取权限
- 操作：保存并重新安装应用到当前租户/群

## 7. 启动与部署
### 7.1 Gunicorn（后台）
```bash
cd /home/cnooc/python_app/feishu-bitable-receiver
source /home/cnooc/python_app/venv313/bin/activate
nohup gunicorn -w 3 --threads 2 --timeout 120 -b 0.0.0.0:3000 \
  --access-logfile ./logs/access.log \
  --error-logfile  ./logs/error.log  \
  --log-level info --capture-output \
  wsgi:app >/dev/null 2>&1 &
echo $! > gunicorn.pid
```
自检：`curl http://<IP>:3000/healthz` 应返回 `{"status":"ok"}`。

常用维护：
```bash
# 停止
kill $(cat gunicorn.pid)
# 重启
kill $(cat gunicorn.pid) 2>/dev/null || pkill -f "gunicorn .*wsgi:app" || true
nohup gunicorn ... & echo $! > gunicorn.pid
# 日志
tail -n 100 logs/error.log
tail -n 100 logs/access.log
```

### 7.2 systemd（生产推荐）
- 将上面的 Gunicorn 参数写入 `ExecStart`，再通过
  `sudo systemctl restart|status feishu-bitable` 管理。

## 8. 使用说明
- 在飞书中向机器人发送 Bitable 链接
- 回复：
  - 成功：`桑基图链接：http://<IP>:3000/sankey/<URL编码文件名>.html`
  - 失败：`桑基图生成失败，请联系服务管理员`
  - 非 Bitable：`该内容不能进行桑基图生成`
- 文件落地：
  - Excel：`OUTPUT_DIR/多维表格名称-发送者ID-北京时间.xlsx`
  - HTML：`SANKEY_OUTPUT_DIR/{预算文件名}_桑基图.html`

## 9. 并发、幂等与安全
- 并发：`gunicorn -w 3 --threads 2 --timeout 120` 足够应对多人并发
- 文件唯一性：
  - Excel：包含“表名-发送者ID-时间”；
  - 边表：`{预算文件名}_edges.xlsx`；生成完成后清理
- 幂等：`message_id` 级别，防止重复处理与多次回复
- 安全：`/sankey/<filename>` 仅允许访问 `SANKEY_OUTPUT_DIR` 内文件，带路径遍历防护

## 10. 故障排查
- 回调 404/重试：查看 `logs/error.log` 与飞书控制台回调状态
- 无法回复：确认 `im:message:send_as_bot` 权限已开并重新安装
- 权限不足：确认 `bitable:app:readonly` 或等价只读权限
- 链接不可点：确认返回链接为 URL 编码；重启服务到最新版本
- 端口不通：确认 gunicorn 监听、内网防火墙已放行 3000

## 11. 后续更新与维护
- 配置：仅改 `.env`，改后重启服务
- 依赖升级：先在测试环境验证，再按离线流程更新
- 日志轮转：建议配置 logrotate 按日切割
- 扩展建议：
  - 高访问量时，用 Nginx 暴露 `/sankey` 并配置 `SANKEY_HTML_BASE_URL`
  - 跨进程幂等可接入 Redis
  - 消息卡片形式返回链接，提升可读性

---
如需将本手册集成到 README 或生成一键运维脚本（run.sh / systemd），可继续告知。

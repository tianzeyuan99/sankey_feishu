# 部署命令

## 1. Mac 本地打包命令

在 Mac 上执行以下命令，生成压缩包：

```bash
cd /Users/tianzeyuan/Desktop

# 删除旧压缩包（可选）
[ -f feishu-bitable-receiver.tar.gz ] && rm feishu-bitable-receiver.tar.gz

# 打包（排除不必要的文件）
tar czf feishu-bitable-receiver.tar.gz \
  --exclude='.venv' \
  --exclude='venv' \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='*.pyo' \
  --exclude='.env' \
  --exclude='.env.*' \
  --exclude='logs' \
  --exclude='*.log' \
  --exclude='*.xlsx' \
  --exclude='*.html' \
  --exclude='.DS_Store' \
  --exclude='*.pid' \
  --exclude='.git' \
  --exclude='test_*.py' \
  --exclude='1111.py' \
  --exclude='output' \
  feishu-bitable-receiver/

# 查看打包结果
ls -lh feishu-bitable-receiver.tar.gz
```

或者直接使用打包脚本：

```bash
cd /Users/tianzeyuan/Desktop/feishu-bitable-receiver
bash package.sh
```

## 2. 服务器部署命令

在服务器上执行以下命令，部署服务：

```bash
cd /home/cnooc/python_app/feishu-bitable-receiver

# 停止服务
kill $(cat gunicorn.pid) 2>/dev/null || pkill -f "gunicorn .*wsgi:app" || true
pkill -f "python sankey_service_with_polling.py" || true
sleep 2

# 备份当前版本
BACKUP_DIR="/home/cnooc/python_app/feishu-bitable-receiver.backup.$(date +%Y%m%d_%H%M%S)"
[ -d "/home/cnooc/python_app/feishu-bitable-receiver" ] && mv /home/cnooc/python_app/feishu-bitable-receiver "$BACKUP_DIR" || true

# 解压新版本
cd /home/cnooc/python_app
tar xzf feishu-bitable-receiver.tar.gz

# 恢复配置和创建目录
cd /home/cnooc/python_app/feishu-bitable-receiver
[ -f "$BACKUP_DIR/.env" ] && cp "$BACKUP_DIR/.env" .env || echo "⚠ 请检查 .env 文件"
mkdir -p logs /home/cnooc/file/excel /home/cnooc/file/sankey

# 安装/更新依赖（重要：确保 pandas 和 openpyxl 已安装）
source /home/cnooc/python_app/venv313/bin/activate
pip install -r requirements.txt --quiet

# 启动服务
nohup gunicorn -w 3 --threads 2 --timeout 120 -b 0.0.0.0:3000 \
  --access-logfile ./logs/access.log \
  --error-logfile  ./logs/error.log  \
  --log-level info --capture-output \
  wsgi:app >/dev/null 2>&1 &
echo $! > gunicorn.pid

# 验证服务
sleep 3
echo "=== 服务状态 ==="
ps -ef | grep 'gunicorn .*wsgi:app' | grep -v grep | head -2
ss -ltnp | grep 3000 || netstat -ltnp | grep 3000
echo ""
echo "=== 健康检查 ==="
curl -s http://10.77.79.147:3000/healthz && echo " - ✓ 通过" || echo " - ⚠ 失败"
```

## 3. 一键部署脚本（可选）

将以下内容保存为 `deploy.sh`，放在服务器上：

```bash
#!/bin/bash
# 服务器一键部署脚本

set -e

PROJECT_DIR="/home/cnooc/python_app/feishu-bitable-receiver"
VENV_PATH="/home/cnooc/python_app/venv313/bin/activate"
TAR_FILE="/home/cnooc/python_app/feishu-bitable-receiver.tar.gz"

echo "=== 开始部署 ==="

# 检查压缩包是否存在
if [ ! -f "$TAR_FILE" ]; then
    echo "❌ 错误: 压缩包不存在: $TAR_FILE"
    echo "请先将 feishu-bitable-receiver.tar.gz 上传到 /home/cnooc/python_app/"
    exit 1
fi

cd "$PROJECT_DIR"

# 停止服务
echo "停止服务..."
kill $(cat gunicorn.pid) 2>/dev/null || pkill -f "gunicorn .*wsgi:app" || true
pkill -f "python sankey_service_with_polling.py" || true
sleep 2

# 备份
echo "备份当前版本..."
BACKUP_DIR="/home/cnooc/python_app/feishu-bitable-receiver.backup.$(date +%Y%m%d_%H%M%S)"
[ -d "$PROJECT_DIR" ] && mv "$PROJECT_DIR" "$BACKUP_DIR" || true

# 解压
echo "解压新版本..."
cd /home/cnooc/python_app
tar xzf feishu-bitable-receiver.tar.gz

# 恢复配置
echo "恢复配置..."
cd "$PROJECT_DIR"
[ -f "$BACKUP_DIR/.env" ] && cp "$BACKUP_DIR/.env" .env || echo "⚠ 请检查 .env 文件"
mkdir -p logs /home/cnooc/file/excel /home/cnooc/file/sankey

# 安装依赖
echo "安装/更新依赖..."
source "$VENV_PATH"
pip install -r requirements.txt --quiet

# 启动服务
echo "启动服务..."
nohup gunicorn -w 3 --threads 2 --timeout 120 -b 0.0.0.0:3000 \
  --access-logfile ./logs/access.log \
  --error-logfile  ./logs/error.log  \
  --log-level info --capture-output \
  wsgi:app >/dev/null 2>&1 &
echo $! > gunicorn.pid

# 验证
sleep 3
echo ""
echo "=== 服务状态 ==="
ps -ef | grep 'gunicorn .*wsgi:app' | grep -v grep | head -2
ss -ltnp | grep 3000 || netstat -ltnp | grep 3000
echo ""
echo "=== 健康检查 ==="
curl -s http://10.77.79.147:3000/healthz && echo " - ✓ 通过" || echo " - ⚠ 失败"

echo ""
echo "✅ 部署完成！"
```

使用方法：

```bash
# 在服务器上执行
chmod +x deploy.sh
./deploy.sh
```

## 4. 新部署服务器配置 .env 文件

如果是**首次部署**到新服务器，需要手动创建 `.env` 配置文件。

### 4.1 创建 .env 文件

在服务器上执行：

```bash
cd /home/cnooc/python_app/feishu-bitable-receiver
vim .env
# 或使用 nano
nano .env
```

### 4.2 .env 配置模板

将以下内容复制到 `.env` 文件中，并根据实际情况修改：

```env
# ========= Feishu credentials =========
APP_ID=cli_xxx                              # 飞书应用 App ID（必填）
APP_SECRET=xxxxxx                            # 飞书应用 App Secret（必填）
OPEN_BASE=https://open.w.cnooc.com.cn       # 飞书 API 网关地址（私有化部署地址）
VERIFICATION_TOKEN=                          # 事件订阅校验 Token（可选，如启用需填写）
ENCRYPT_KEY=                                 # 事件签名密钥（推荐，如启用需填写）

# ========= Service =========
PORT=3000                                    # 服务端口（默认 3000）
HOST=0.0.0.0                                 # 监听地址（0.0.0.0 表示所有网卡）

# ========= 文件导出配置 =========
OUTPUT_DIR=/home/cnooc/file/excel            # Excel 文件输出目录（需确保目录存在且有写权限）
EXPORT_CSV=false                             # 是否导出 CSV（固定 false，只导出 Excel）
EXPORT_XLSX=true                              # 是否导出 Excel（固定 true）
BASE_AUTO_PICK=first                         # 仅 base 链接时的选择策略：first（第一张表/视图）
BASE_PREFERRED_TABLE=                        # 按名称优先时的表名（可留空）
BASE_PREFERRED_VIEW=                         # 按名称优先时的视图名（可留空）

# ========= 日志 =========
MESSAGES_LOG_PATH=/home/cnooc/python_app/feishu-bitable-receiver/logs/messages.log

# ========= 桑基图 =========
SANKEY_SERVICE_PATH=                         # 桑基图服务路径（已内置，可留空）
SANKEY_OUTPUT_DIR=/home/cnooc/file/sankey   # 桑基图 HTML 输出目录（需确保目录存在且有写权限）
SANKEY_WATCH_DIR=/home/cnooc/file/excel     # 工作目录（通常与 OUTPUT_DIR 一致）
SANKEY_LOG_FILE=/home/cnooc/python_app/feishu-bitable-receiver/logs/sankey_service.log
SANKEY_POLL_INTERVAL=2                       # 轮询间隔（兼容用，实际不启轮询）
SANKEY_HTML_BASE_URL=                        # 可选：若用 Nginx 提供静态访问，设置为 http://IP:端口/sankey
```

### 4.3 配置说明

**必填项：**
- `APP_ID`: 飞书应用的 App ID，在飞书开放平台获取
- `APP_SECRET`: 飞书应用的 App Secret，在飞书开放平台获取
- `OPEN_BASE`: 飞书 API 网关地址
  - 私有化部署：`https://open.w.cnooc.com.cn`（根据实际地址修改）
  - 公有云：`https://open.feishu.cn`
- `OUTPUT_DIR`: Excel 文件输出目录，需确保目录存在且有写权限
- `SANKEY_OUTPUT_DIR`: 桑基图 HTML 输出目录，需确保目录存在且有写权限

**可选项：**
- `VERIFICATION_TOKEN`: 事件订阅校验 Token（如启用需填写）
- `ENCRYPT_KEY`: 事件签名密钥（推荐启用，提高安全性）
- `SANKEY_HTML_BASE_URL`: 如果使用 Nginx 等反向代理提供静态文件访问，可设置此值

### 4.4 创建必要的目录

在创建 `.env` 文件后，确保以下目录存在：

```bash
# 创建输出目录
mkdir -p /home/cnooc/file/excel
mkdir -p /home/cnooc/file/sankey

# 创建日志目录
mkdir -p /home/cnooc/python_app/feishu-bitable-receiver/logs

# 设置目录权限（根据实际运行用户调整）
chown -R cnooc:cnooc /home/cnooc/file
chown -R cnooc:cnooc /home/cnooc/python_app/feishu-bitable-receiver/logs
```

### 4.5 验证配置

配置完成后，可以验证配置是否正确：

```bash
# 激活虚拟环境
source /home/cnooc/python_app/venv313/bin/activate

# 测试导入配置（检查是否有语法错误）
cd /home/cnooc/python_app/feishu-bitable-receiver
python3 -c "from dotenv import load_dotenv; import os; load_dotenv(); print('APP_ID:', os.getenv('APP_ID')); print('OPEN_BASE:', os.getenv('OPEN_BASE'))"
```

如果输出正确显示配置值，说明 `.env` 文件配置成功。

### 4.6 注意事项

1. **安全性**：`.env` 文件包含敏感信息（APP_SECRET），请妥善保管，不要提交到 Git
2. **路径**：所有路径必须是绝对路径，确保目录存在且有写权限
3. **格式**：每行一个配置项，格式为 `KEY=VALUE`，不要有多余的空格
4. **注释**：以 `#` 开头的行为注释，不会被执行
5. **备份**：修改 `.env` 前建议先备份：`cp .env .env.bak.$(date +%Y%m%d%H%M)`

